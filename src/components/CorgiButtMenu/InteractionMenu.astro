---
import CorgiButtPixi from './CorgiButtPixi.astro';

const menuItems = [
	{ label: 'About', target: 'about' },
	{ label: 'Works', target: 'works' },
	{ label: 'Skills', target: 'skills' },
	{ label: 'Contact', target: 'contact' },
];
---

<div id="interaction-container">
	{menuItems.map((item) => (
		<div class="menu-item" data-target={item.target}>{item.label}</div>
	))}

	<CorgiButtPixi />
</div>

<style>
	#interaction-container {
		position: relative;
		width: 100%;
		flex-grow: 1;
		display: flex;
		justify-content: center;
		align-items: center;
		padding-top: 0px; 
	}

	.menu-item {
		position: absolute;
		top: 53%;
		left: 50%;
		width: 110px;
		height: 46px;
		border-radius: 23px;
		background-color: white;
		border: 3px solid #FFC1CC; 
		display: flex;
		justify-content: center;
		align-items: center;
		font-weight: 800;
		font-size: 1.1rem;
		color: #E8995E;
		box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
		transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		user-select: none;
		z-index: 5;
		cursor: pointer;
		/* 中央基準で配置するためのオフセット */
		margin-left: -55px;
		margin-top: -23px;
	}
	
	.menu-item.active {
		background-color: #FFB7C5;
		border-color: #FFB7C5;
		color: white;
		/* scale属性を削除。JS側のGSAPでのみ制御する */
		box-shadow: 0 0 25px rgba(255, 183, 197, 0.7);
	}
</style>

<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<script is:inline>
	// --- 設定 ---
	const menuRadius = 180; // さらにお尻に近づける (180 -> 150)

	// --- コンテンツデータ ---
	const contents = {
		about: { title: "About Me", text: "コーギーが大好きなWebデザイナーです。<br>ふわふわしたデザインが得意です。" },
		works: { title: "My Works", text: "これまでに作成したWebサイトや<br>イラストのギャラリーです。" },
		skills: { title: "Skills", text: "HTML / CSS / JavaScript / Figma<br>わんちゃんのお世話も得意です。" },
		contact: { title: "Contact", text: "お仕事のご依頼はこちらから！<br>お散歩のお誘いも待ってます。" }
	};

	// --- 初期配置 (馬蹄形に並べる) ---
	const menuItems = document.querySelectorAll('.menu-item');
	
	// About (左上寄りの横), Works (右上寄りの横), Skills (左下), Contact (右下)
	// 上（-90/270度）は空ける
	const angles = [200, -20, 140, 40]; 

	menuItems.forEach((item, index) => {
		const angleDeg = angles[index];
		const angleRad = (angleDeg * Math.PI) / 180;
		const x = Math.cos(angleRad) * menuRadius;
		const y = Math.sin(angleRad) * menuRadius;
		
		// 回転を 0-360 の範囲で正規化して、文字が逆さま(90~270度)なら反転させる
		let rotation = (angleDeg + 90) % 360;
		if (rotation < 0) rotation += 360;
		
		if (rotation > 90 && rotation < 270) {
			rotation -= 180;
		}
		
		gsap.set(item, { 
			x: x, 
			y: y, 
			rotation: rotation,
			scale: 1 
		});
		
		item.dataset.baseRotation = rotation;
	});

	// --- イベント監視 ---
	let currentHitItem = null;

	window.addEventListener('corgi-drag', (e) => {
		const { x, y } = e.detail;
		checkCollision(x, y);
	});

	window.addEventListener('corgi-drop', () => {
		if (currentHitItem) {
			const targetKey = currentHitItem.getAttribute('data-target');
			updateContent(targetKey);
			// 決定時のプルンとしたアニメーション
			gsap.fromTo(currentHitItem, { scale: 1.4 }, { scale: 1.15, duration: 0.4, ease: "back.out" });
		}
	});

	function checkCollision(x, y) {
		let foundHit = false;
		menuItems.forEach(item => {
			const rect = item.getBoundingClientRect();
			const padding = 20; 
			if (x >= rect.left - padding && x <= rect.right + padding &&
				y >= rect.top - padding && y <= rect.bottom + padding) {
				
				if (!item.classList.contains("active")) {
					item.classList.add("active");
					gsap.to(item, { scale: 1.15, duration: 0.3, ease: "power2.out" });
				}
				currentHitItem = item;
				foundHit = true;
			} else {
				if (item.classList.contains("active")) {
					item.classList.remove("active");
					gsap.to(item, { scale: 1, duration: 0.3, ease: "power2.out" });
				}
			}
		});
		if (!foundHit) currentHitItem = null;
	}

	function updateContent(key) {
		const data = contents[key];
		const titleEl = document.getElementById('display-title');
		const textEl = document.getElementById('display-text');

		if (!data || !titleEl || !textEl) return;

		gsap.to([titleEl, textEl], {
			opacity: 0,
			y: -10,
			duration: 0.2,
			onComplete: () => {
				titleEl.innerText = data.title;
				textEl.innerHTML = data.text;
				gsap.to([titleEl, textEl], { opacity: 1, y: 0, duration: 0.3 });
			}
		});
	}
</script>

